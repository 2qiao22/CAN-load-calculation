# CAN負荷計算機の共有
西南石油大学がRoboMaster　BBSに投稿していたものを我々でも使えるように少し改良を加えたものである。
このブックを作成するにあたってデータを共有してくれた彼らには感謝をする。

## はじめに
競技の技術レベルが向上するにつれて、モーターの需要が増加しています。RMで多く使用されるのは、CAN通信を用いたモーターですが、従来のCANプロトコルは最大1Mbpsのボーレートに制限され、1000Hzの制御周波数では多くのモーターを接続できません。
1つのCANバスで接続できるモーターは6〜7個程度です。現在、各チームはRoboMaster開発ボードA\Cを使用していますが、これらにはCAN周辺機器リソースが2つしかありません。多数のモーターを制御するには、CAN周辺機器の数を増やすか、制御周波数を下げてバス負荷を軽減する必要があります。
この記事で説明されているように、CANバスの負荷を計算するためのツールを作成することで、ロボットの設計段階で制御ニーズを満たすための適切なCANバスの割り当てが可能になります。このツールは、制御周波数を調整したり、モーターの数に応じてCAN通信のボーレートやデータ量の管理を最適化するのに役立ちます。

## CANバスパケット損失を回避するいくつかの方法
バス負荷を管理するための実際の経験と対策について、いくつかの重要な要素を挙げていただきました。これらは、CAN通信の安定性を確保するために非常に重要です。特に、バス抵抗や電磁干渉への対応についての具体的な知見は、実際の運用において役立ちます。
https://blog.csdn.net/2301_78942143/article/details/133250774
以下は、挙げられた経験に基づいて、CAN通信の安定性を向上させるためのポイントです：
1. バス抵抗の管理
バス抵抗を60Ωに保つことが推奨されている理由は、信号反射を最小限に抑え、通信品質を保つためです。CAN通信において、終端抵抗が適切でない場合、信号の反射や波形の歪みが生じ、これがパケット損失や通信不良を引き起こす原因となります。テスト結果に基づくと、30Ω〜120Ωの範囲で通信は可能ですが、40Ωを下回るとバス負荷が高くなり、パケット損失が発生しやすくなるとのことです。このため、60Ωという設定が最適だとされています。端子抵抗の適切な設定が通信の安定性に与える影響については、さまざまな文献で言及されています。

対策:

ESC（エレクトロニック・スピード・コントローラー）を交換した後、CAN通信に問題が発生した場合、端子抵抗が正しく設定されているか確認する。
端子抵抗が1つだけバスに接続されていることを確認。
マルチメーターを使用して、電源をオフにした状態でバス抵抗を測定し、抵抗値が適切であることを確認。
2. 差動信号への電磁干渉の軽減
CANバスは差動信号を使用しており、外部からの電磁干渉（EMI）に対して敏感です。このため、配線にはツイストペアケーブルを使用することで、電磁干渉を低減できます。ツイストペアケーブルは、2本の線をねじり合わせて配置することで、外部ノイズに対して強い耐性を持ち、信号の品質を保つ効果があります。

対策:

ツイストペアケーブルを使用して配線し、外部からの電磁干渉を最小限に抑える。
配線ルートやケーブルの配置にも注意を払い、電源線や高電流の配線から遠ざける。

